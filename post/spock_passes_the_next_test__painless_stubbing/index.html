<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="description" content="">
<meta name="keywords" content="java, spock, testing, groovy, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Spock passes the next test - Painless Stubbing : trishagee.github.io"/>
<meta property="og:site_name" content="Trisha Gee"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="http://trishagee.github.io/post/spock_passes_the_next_test__painless_stubbing">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2013-07-10"/>
<meta property="article:modified_time" content="2013-07-10"/>

<meta property="article:tag" content="java">
<meta property="article:tag" content="spock">
<meta property="article:tag" content="testing">
<meta property="article:tag" content="groovy">



<meta name="twitter:card" content="summary">

<meta name="twitter:site" content="@trisha_gee">
<meta name="twitter:title" content="Spock passes the next test - Painless Stubbing : trishagee.github.io">
<meta name="twitter:creator" content="@trishagee">
<meta name="twitter:description" content="">
<meta name="twitter:image:src" content="">
<meta name="twitter:domain" content="trishagee.github.io">



    <base href="http://trishagee.github.io/">
    <title> Spock passes the next test - Painless Stubbing - trishagee.github.io </title>
    <link rel="canonical" href="http://trishagee.github.io/post/spock_passes_the_next_test__painless_stubbing">
    

    <link href='http://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://trishagee.github.io/static/css/style.css">
<link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/default.min.css">
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
    <div id="byline">by Trisha Gee</div>
    <nav id="nav">
        <ul id="mainnav">
    <li>
        <a href="http://trishagee.github.io/post/">
            <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
            <span> blog </span>
        </a>
    </li>
    <li>
        <a href="http://trishagee.github.io/project/">
            <span class="icon"> <i aria-hidden="true" class="icon-console"></i></span>
            <span> code </span>
        </a>
    </li>
    <li>
        <a href="http://trishagee.github.io/presentation/">
            <span class="icon"> <i aria-hidden="true" class="icon-stats"></i></span>
            <span> talks </span>
        </a>
    </li>
    <li>
        <a href="http://trishagee.github.io/resources/">
            <span class="icon"> <i aria-hidden="true" class="icon-gears"></i></span>
            <span> resources </span>
        </a>
    </li>
</ul>

        <ul id="social">
    <li id="share">
        <span class="icon icon-bubbles"> </span>
        <span class="title"> share </span>

        <div class="dropdown share">
            <ul class="social">
                <li><a href="https://twitter.com/intent/tweet?status=Spock%20passes%20the%20next%20test%20-%20Painless%20Stubbing-http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing" target="_blank"
                       title="Follow me on Twitter" class="twitter"><span class="icon icon-twitter"></span>Twitter</a></li>
                <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing" target="_blank" title="Join me on Facebook"
                       class="facebook"><span class="icon icon-facebook"></span>Facebook</a></li>
                <li><a href="https://plus.google.com/share?url=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing" target="_blank" title="Google+" class="googleplus"><span
                        class="icon icon-google-plus"></span>Google+</a></li>
                <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing&title=Spock%20passes%20the%20next%20test%20-%20Painless%20Stubbing&source=spf13"
                       target="_blank" title="LinkedIn" class="linkedin"><span class="icon icon-linkedin"></span>LinkedIn</a></li>
                <li><a href="http://del.icio.us/post?url=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing" target="_blank" title="Delicious" class="delicious"><span
                        class="icon icon-delicious"></span>Delicious</a></li>
                <li><a href="http://www.reddit.com/submit?url=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing" target="_blank" title="Reddit" class="reddit"><span
                        class="icon icon-reddit"></span>Reddit</a></li>
                <li><a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing" target="_blank" title="StumbleUpon"
                       class="stumbleupon"><span class="icon icon-stumbleupon"></span>StumbleUpon</a></li>
                <li><a href="http://www.dzone.com/links/add.html?url=http%3a%2f%2ftrishagee.github.io%2fpost%2fspock_passes_the_next_test__painless_stubbing&title=Spock%20passes%20the%20next%20test%20-%20Painless%20Stubbing" target="_blank" title="DZone"
                       class="dzone"><span class="icon icon-dzone"></span>DZone</a></li>
            </ul>
            <span class="subcount">sharing is caring</span>
        </div>
    </li>
    <li id="follow">
        <span class="icon icon-rocket"> </span>
        <span class="title"> follow </span>

        <div class="dropdown follow">
            <ul class="social">
                <li><a href="http://trishagee.github.io/index.xml" target="_blank" title="Subscribe by RSS" class="rss"><span
                        class="icon icon-feed-2"></span>RSS</a></li>
                <li><a href="http://www.twitter.com/trisha_gee" target="_blank" title="Follow me on Twitter" class="twitter"><span
                        class="icon icon-twitter"></span>Twitter</a></li>
                <li><a href="http://www.linkedin.com/in/trishagee" target="_blank" title="LinkedIn" class="linkedin"><span class="
                        icon icon-linkedin"></span>LinkedIn</a></li>
                <li><a href="http://github.com/trishagee" target="_blank" title="GitHub" class="github"><span class="
                        icon icon-github"></span>GitHub</a></li>
                <li><a href="http://www.slideshare.net/trishagee" target="_blank" title="SlideShare" class="slideshare"><span
                        class="icon icon-slideshare"></span>SlideShare</a></li>
                <li><a href="https://plus.google.com/+TrishaGee/" target="_blank" title="Google+" class="googleplus"><span
                        class="icon icon-google-plus"></span>Google+</a></li>
            </ul>
            <span class="subcount"></span>
        </div>
    </li>
</ul>

    </nav>
</header>



<section id="main">
  <h1 itemprop="name" id="title">Spock passes the next test - Painless Stubbing</h1>
  <div>
        <article itemprop="articleBody" id="content">
           <p>In the <a href="http://mechanitis.blogspot.co.uk/2013/07/spock-is-awesome-seriously-simplified.html">last post</a> I talked about our need for some improved testing tools, our choice of <a href="https://code.google.com/p/spock/">Spock</a> as something to spike, and how mocking looks in Spock.<br /><br />As that blog got rather long, I saved the next installment for a separate post.<br /><br />Today I want to look at stubbing.<br /><br /><b>Stubbing</b><br />Mocking is great for checking <i>outputs</i> - in the example in the last post, we&rsquo;re checking that the process of encoding an array calls the right things on the way out, if you like - that the right stuff gets poked onto the <code>bsonWriter</code>.<br /><br />Stubbing is great for faking your <i>inputs</i> (I don&rsquo;t know why this difference never occurred to me before, but&nbsp;<a href="http://www.devoxx.com/display/UK13/I+hate+writing+unit+tests%2C+how+come+everybody+else+enjoys+it">Colin&rsquo;s talk at Devoxx UK</a>&nbsp;made this really clear to me). <br /><br />One of the things we need to do in the compatibility layer of the new driver is to wrap all the new style Exceptions that can be thrown by the new architecture layer and turn them into old-style Exceptions, for backwards compatibility purposes. &nbsp;Sometimes testing the exceptional cases is&hellip; challenging. &nbsp;So I opted to do this with Spock.<br /><br />So here we can use a real <code>DB</code> class, but with a mock <code>Mongo</code> that will return us a &ldquo;mock&rdquo; <code>Session</code>. &nbsp;It&rsquo;s not actually a mock though, it&rsquo;s more of a stub because we want to tell it how to behave when it&rsquo;s called - in this test, we want to force it to throw an <code>org.mongodb.MongoException</code> whenever <code>execute</code> is called. &nbsp;It doesn&rsquo;t matter to us what get passed in to the execute method (that&rsquo;s what the underscore means on line 16), what matters is that when it gets called it throws the correct type of Exception.<br /><br />Like before, the <code>when</code>: section shows the bit we&rsquo;re actually trying to test. In this case, we want to call <code>rename</code>.<br /><br />Then finally the <code>then:</code> section asserts that we received the correct sort of Exception. &nbsp;It&rsquo;s not enormously clear, although I&rsquo;ve kept the full namespace in to try and clarify, but the aim is that any <code><b>org</b>.mongodb.MongoException</code> that gets thrown by the new architecture gets turned into the appropriate <code><b>com</b>.mongodb.MongoException</code>. &nbsp;We&rsquo;re sort of &ldquo;lucky&rdquo; because the old code is in the wrong package structure, and in the new architecture we&rsquo;ve got a chance to fix this and put stuff into the right place.<br /><br />Once I&rsquo;d tracked down all the places Exceptions can escape and started writing these sorts of tests to exercise those code paths, not only did I feel more secure that we wouldn&rsquo;t break backwards compatibility by leaking the wrong Exceptions, but we also found our test coverage went up - and more importantly, in the <i>un</i>happy paths, which are often harder to test.<br /><br />I mentioned in the last post that we already did some simple stubbing to help us test the data driver. Why not just keep using that approach?  <br /><br />Well, these stubs end up looking like this:<br /><br />Ick.<br /><br />And you end up extending them so you can just override the method you&rsquo;re interested in (particularly in the case of forcing a method to throw an exception). &nbsp;Most irritatingly to me, these stubs live away from the actual tests, so you can&rsquo;t easily see what the expected behaviour is. &nbsp;In the Spock test, the expected stubbed behaviour is defined on line 16, the call that will provoke it is on line 19 and the code that checks the expectation is on line 22. &nbsp;It&rsquo;s all within even the smallest monitor&rsquo;s window.<br /><br />So stubbing in Spock is painless. &nbsp;Next:<br /><ul><li><a href="http://mechanitis.blogspot.com.es/2013/12/spock-data-driven-testing.html">Data Driven Testing</a></li></ul><br /></p>

        </article>
  </div>
</section>



<aside id="meta">

<div>
    <section id="datecount">
        <h4 id="date"> Wed Jul 10, 2013 </h4>
        <h5 id="wc"> 600 Words </h5>
    </section>
    <ul id="categories">
        
    </ul>
    <ul id="tags">
        
        <li><a href="http://trishagee.github.io//tags/java">java</a></li>
        
        <li><a href="http://trishagee.github.io//tags/spock">spock</a></li>
        
        <li><a href="http://trishagee.github.io//tags/testing">testing</a></li>
        
        <li><a href="http://trishagee.github.io//tags/groovy">groovy</a></li>
        
    </ul>
</div>

<div>
    <section id="prev">
        &nbsp;<a class="previous" href="http://trishagee.github.io/post/cant_take_much_more"><i class="icon-arrow-left"></i> Can&#39;t. Take. Much. More.</a><br>
    </section>
    <section id="next">
        &nbsp;<a class="next" href="http://trishagee.github.io/post/spock_is_awesome_seriously_simplified_mocking">Spock is awesome! Seriously Simplified Mocking <i class="icon-arrow-right"></i></a>
    </section>
</div>

<div>
    <section id="author">
        <h4>About the Author:</h4>
        Trisha is a developer for <a href="http://mongodb.com">MongoDB Inc.</a> and a leader of the Sevilla Java User Group, she believes we
        shouldn't all have to make the same mistakes again and again.
    </section>
</div>

</aside>

<meta itemprop="wordCount" content="568">
<meta itemprop="datePublished" content="2013-07-10">
<meta itemprop="url" content="http://trishagee.github.io/post/spock_passes_the_next_test__painless_stubbing">


<aside id=comments>
    <div><h2> Comments </h2></div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'trishagee';
    var disqus_identifier = 'http:\/\/trishagee.github.io\/post\/spock_passes_the_next_test__painless_stubbing';
    var disqus_title = 'Spock passes the next test - Painless Stubbing';
    var disqus_url = 'http:\/\/trishagee.github.io\/post\/spock_passes_the_next_test__painless_stubbing\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
    <div>
        <p>
            &copy; 2013-14 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Trisha Gee.</span></span>
            <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons Attribution">Some rights reserved</a>;
            please attribute properly and link back. <br>
            Powered by <a href="http://hugo.spf13.com">Hugo</a>.
            Original layout created by Steve Francia <a href="http://http://spf13.com/">http://spf13.com/</a>, derived from <a
                href="https://github.com/spf13/spf13.com">https://github.com/spf13/spf13.com</a>.
        </p>
    </div>
</footer>
<script type="text/javascript">

    var _gaq = _gaq || [];

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-49006189-1', 'trishagee.github.io');
    ga('send', 'pageview');

    (function () {
        var j = function (a, b) {
            return window.getComputedStyle ? getComputedStyle(a).getPropertyValue(b) : a.currentStyle[b]
        };
        var k = function (a, b, c) {
            if (a.addEventListener)a.addEventListener(b, c, false); else a.attachEvent('on' + b, c)
        };
        var l = function (a, b) {
            for (key in b)if (b.hasOwnProperty(key))a[key] = b[key];
            return a
        };
        window.fitText = function (d, e, f) {
            var g = l({'minFontSize': -1 / 0, 'maxFontSize': 1 / 0}, f);
            var h = function (a) {
                var b = e || 1;
                var c = function () {
                    a.style.fontSize = Math.max(Math.min(a.clientWidth / (b * 10), parseFloat(g.maxFontSize)), parseFloat(g.minFontSize)) + 'px'
                };
                c();
                k(window, 'resize', c)
            };
            if (d.length)for (var i = 0; i < d.length; i++)h(d[i]); else h(d);
            return d
        }
    })();
    fitText(document.getElementById('title'), 1)

</script>
</body>
</html>

