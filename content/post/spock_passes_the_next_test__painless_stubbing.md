{
 "disqus_url" : "http://trishagee.github.io/post/spock_passes_the_next_test__painless_stubbing/",
 "disqus_title" : "Spock passes the next test - Painless Stubbing",
 "Title": "Spock passes the next test - Painless Stubbing",
 "Pubdate": "2013-07-10",
 "Slug": "spock_passes_the_next_test__painless_stubbing",
 "Section": "post"
}
In the <a href="http://mechanitis.blogspot.co.uk/2013/07/spock-is-awesome-seriously-simplified.html">last post</a> I talked about our need for some improved testing tools, our choice of <a href="https://code.google.com/p/spock/">Spock</a> as something to spike, and how mocking looks in Spock.<br /><br />As that blog got rather long, I saved the next installment for a separate post.<br /><br />Today I want to look at stubbing.<br /><br /><b>Stubbing</b><br />Mocking is great for checking <i>outputs</i> - in the example in the last post, we're checking that the process of encoding an array calls the right things on the way out, if you like - that the right stuff gets poked onto the <code>bsonWriter</code>.<br /><br />Stubbing is great for faking your <i>inputs</i> (I don't know why this difference never occurred to me before, but&nbsp;<a href="http://www.devoxx.com/display/UK13/I+hate+writing+unit+tests%2C+how+come+everybody+else+enjoys+it">Colin's talk at Devoxx UK</a>&nbsp;made this really clear to me). <br /><br />One of the things we need to do in the compatibility layer of the new driver is to wrap all the new style Exceptions that can be thrown by the new architecture layer and turn them into old-style Exceptions, for backwards compatibility purposes. &nbsp;Sometimes testing the exceptional cases is... challenging. &nbsp;So I opted to do this with Spock.<br /><br /><script src="https://gist.github.com/trishagee/5935645.js"></script>So here we can use a real <code>DB</code> class, but with a mock <code>Mongo</code> that will return us a "mock" <code>Session</code>. &nbsp;It's not actually a mock though, it's more of a stub because we want to tell it how to behave when it's called - in this test, we want to force it to throw an <code>org.mongodb.MongoException</code> whenever <code>execute</code> is called. &nbsp;It doesn't matter to us what get passed in to the execute method (that's what the underscore means on line 16), what matters is that when it gets called it throws the correct type of Exception.<br /><br />Like before, the <code>when</code>: section shows the bit we're actually trying to test. In this case, we want to call <code>rename</code>.<br /><br />Then finally the <code>then:</code> section asserts that we received the correct sort of Exception. &nbsp;It's not enormously clear, although I've kept the full namespace in to try and clarify, but the aim is that any <code><b>org</b>.mongodb.MongoException</code> that gets thrown by the new architecture gets turned into the appropriate <code><b>com</b>.mongodb.MongoException</code>. &nbsp;We're sort of "lucky" because the old code is in the wrong package structure, and in the new architecture we've got a chance to fix this and put stuff into the right place.<br /><br />Once I'd tracked down all the places Exceptions can escape and started writing these sorts of tests to exercise those code paths, not only did I feel more secure that we wouldn't break backwards compatibility by leaking the wrong Exceptions, but we also found our test coverage went up - and more importantly, in the <i>un</i>happy paths, which are often harder to test.<br /><br />I mentioned in the last post that we already did some simple stubbing to help us test the data driver. Why not just keep using that approach?  <br /><br />Well, these stubs end up looking like this:<br /><br /><script src="https://gist.github.com/trishagee/5935655.js"></script>Ick.<br /><br />And you end up extending them so you can just override the method you're interested in (particularly in the case of forcing a method to throw an exception). &nbsp;Most irritatingly to me, these stubs live away from the actual tests, so you can't easily see what the expected behaviour is. &nbsp;In the Spock test, the expected stubbed behaviour is defined on line 16, the call that will provoke it is on line 19 and the code that checks the expectation is on line 22. &nbsp;It's all within even the smallest monitor's window.<br /><br />So stubbing in Spock is painless. &nbsp;Next:<br /><ul><li><a href="http://mechanitis.blogspot.com.es/2013/12/spock-data-driven-testing.html">Data Driven Testing</a></li></ul><br />
