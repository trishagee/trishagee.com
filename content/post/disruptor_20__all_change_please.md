{
 "disqus_url" : "http://trishagee.github.io/post/disruptor_20__all_change_please/",
 "disqus_title" : "Disruptor 2.0 - All Change Please",
 "Title": "Disruptor 2.0 - All Change Please",
 "Pubdate": "2011-08-30",
 "Keywords": ["java", "disruptor", "disruptor-docs", "concurrency"],
 "Tags": ["java", "disruptor", "disruptor-docs", "concurrency"],
 "Slug": "disruptor_20__all_change_please",
 "Section": "post"
}
Martin recently <a href="http://mechanical-sympathy.blogspot.com/2011/08/disruptor-20-released.html">announced version 2.0</a> of <a href="http://code.google.com/p/disruptor/">the Disruptor</a>&nbsp;- basically there have been so many changes since we first open-sourced it that it's time to mark that officially. &nbsp;His post goes over all the changes, the aim of this article is to attempt to translate my previous blog posts into new-world-speak, since it's going to take a long time to re-write each of them all over again.  Now I see the disadvantage of hand-drawing everything.<br /><br /><b>In the old world</b><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-R3vHFiqPCPo/TlvTk9cQEvI/AAAAAAAAIKA/1-o7vhoxGnQ/s1600/1P3C-Diamond-RingBuffer.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="356" src="http://1.bp.blogspot.com/-R3vHFiqPCPo/TlvTk9cQEvI/AAAAAAAAIKA/1-o7vhoxGnQ/s640/1P3C-Diamond-RingBuffer.png" width="640" /></a></div><br />This is an example of a configuration of the Disruptor (specifically a diamond configuration). &nbsp;If none of this means anything to you, feel free to go back and refresh yourself on all the (now outdated) <a href="http://mechanitis.blogspot.com/search/label/disruptor">Disruptor details</a>.<br /><br />The most obvious changes over the last few weeks have been:<br /><ol><li>Updated naming convention</li><li>Integrating the producer barrier into the ring buffer</li><li>Adding the <a href="http://www.symphonious.net/2011/07/11/lmax-disruptor-high-performance-low-latency-and-simple-too/">Disruptor wizard</a> into the main code base.</li></ol><div><b>The New World Order</b></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-4aCmflSb7Fs/TlvZ5z8BesI/AAAAAAAAIKE/kAXR_7Ly5FI/s1600/NewWorldOrder.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="219" src="http://2.bp.blogspot.com/-4aCmflSb7Fs/TlvZ5z8BesI/AAAAAAAAIKE/kAXR_7Ly5FI/s640/NewWorldOrder.png" width="640" /></a></div><div><br /></div><div>You'll see the fundamentals are pretty much the same. &nbsp;It's simpler, because the <code>ProducerBarrier</code> is no longer an entity in its own right - its replacement is the <code>PublishPort</code> interface, which is implemented by the <code>RingBuffer</code> itself.</div><div><br /></div><div>Similarly the name <code>DependencyBarrier</code> instead of <code>ConsumerBarrier</code> clarifies the job of this object; <code>Publisher</code> (instead of <code>Producer</code>) and <code>EventProcessor</code> instead of <code>Consumer</code> also more accurately represent what these things do. &nbsp;There was always a little confusion over the name <code>Consumer</code>, since consumers never actually consumed anything from the ring buffer.  It was simply a term that we hoped would make sense to those who were used to queue implementations.</div><div><br /></div><div>Not shown on the diagram is the name change of the items in the <code>RingBuffer</code> - in the old world, we called this <code>Entry</code>, now they're an <code>Event</code>, hence <code>EventProcessor</code> at the other end.</div><div><br /></div><div>The aim of this wholesale rename has not been to completely discredit all my old blogs so I can continue blogging about the Disruptor <i>ad infinitum</i>. This is far from what I want - I have other, more fluffy, things to write about. &nbsp;The aim of the rename is to make it easier to understand how the Disruptor works and how to use it. Although <a href="http://www.lmaxtrader.co.uk/">we</a> use the Disruptor for event processing, when we open sourced it we wanted it to look like a general purpose solution, so the naming convention tried to represent that. &nbsp;But in fact the event processing model does seem more intuitive.<br /><br /><b>No more tedious wiring</b><br />Now the <a href="http://www.symphonious.net/2011/08/13/the-disruptor-wizard-is-dead-long-live-the-disruptor-wizard/">Disruptor wizard is part of the Disruptor</a> itself, my whole <a href="http://mechanitis.blogspot.com/2011/07/dissecting-disruptor-wiring-up.html">post on wiring</a> is pretty pointless - which is good, actually, because it was a little involved.<br /><br />These days, if you want to create the diamond pattern (for example the <a href="http://code.google.com/p/disruptor/source/browse/trunk/code/src/perf/com/lmax/disruptor/DiamondPath1P3CPerfTest.java?r=294">FizzBuzz</a> performance test), it's a lot simpler:</div><div><blockquote><pre>DisruptorWizard dw = new DisruptorWizard&lt;FizzBuzzEvent&gt;(<br />                         ENTRY_FACTORY, <br />                         RING_BUFFER_SIZE, <br />                         EXECUTOR,<br />                         ClaimStrategy.Option.SINGLE_THREADED,<br />                         WaitStrategy.Option.YIELDING);<br />FizzBuzzEventHandler fizzHandler = <br />                         new FizzBuzzEventHandler(FIZZ);<br />FizzBuzzEventHandler buzzHandler = <br />                         new FizzBuzzEventHandler(BUZZ);<br />FizzBuzzEventHandler fizzBuzzHandler = <br />                         new FizzBuzzEventHandler(FIZZ_BUZZ);<br /><br />dw.handleEventsWith(fizzHandler, buzzHandler)<br />  .then(fizzBuzzHandler);<br /><br />RingBuffer ringBuffer = dw.start();<br /></pre></blockquote></div><div>Note there is a <a href="http://code.google.com/p/disruptor/wiki/DisruptorWizard">Wiki page</a> on the Disruptor Wizard.<br /><br /><b>Other changes: performance improvements</b><br />As Martin mentions in <a href="http://mechanical-sympathy.blogspot.com/2011/08/disruptor-20-released.html">his post</a>, he's managed to significantly improve the performance (even more!) of the Disruptor in 2.0. <br /><br />The short version of this is that there is a shiny new class,&nbsp;<code>Sequence</code>, which both takes care of the <a href="http://mechanitis.blogspot.com/2011/07/dissecting-disruptor-why-its-so-fast_22.html">cache line padding</a>, and removes the need for <a href="http://mechanitis.blogspot.com/2011/08/dissecting-disruptor-why-its-so-fast.html">memory barriers</a>. &nbsp;The cache line padding is now done slightly differently because, bless Java 7's little cotton socks, it managed to "optimise" our old technique away.<br /><br />I'll leave you to read the details over there, in this post I just wanted to give a quick summary of the changes and explain why my old diagrams may no longer be correct.</div>
